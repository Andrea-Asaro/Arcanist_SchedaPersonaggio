<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Scheda Arcanist - Web App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {},
        screens: {
          sm: "640px",
          md: "768px",
          lg: "1250px",   // <— NUOVO BREAKPOINT DESKTOP
          xl: "1350px",
        }
      }
    }
  </script>

  <style>
    .hidden-input {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>

<body class="bg-slate-900 text-slate-100 min-h-screen">
  <div class="max-w-7xl xl:max-w-[1400px] mx-auto px-6 py-6">
    <!-- Header app -->
    <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-6">
      <div>
        <h1 class="text-2xl font-semibold tracking-tight">Scheda Arcanist</h1>
        <p class="text-sm text-slate-300">Gestione personaggi GDR in locale (nessun account, nessun server).</p>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="btnExport" class="text-sm px-3 py-2 rounded-xl border border-slate-500 hover:bg-slate-800 disabled:opacity-40 disabled:cursor-not-allowed">
          Esporta scheda
        </button>
        <button id="btnImport" class="text-sm px-3 py-2 rounded-xl border border-indigo-500 hover:bg-indigo-600 hover:border-indigo-400 bg-indigo-500">
          Importa scheda
        </button>
        <input type="file" id="importInput" accept=".json,.txt,application/json,text/plain" class="hidden-input" />
      </div>
    </header>

    <!-- Start screen -->
    <section id="startScreen" class="mt-10">
      <div class="grid gap-6 sm:grid-cols-2">
        <button id="btnStartNew"
                class="rounded-2xl border border-slate-700 bg-slate-800/60 px-5 py-6 text-left hover:bg-slate-700 transition">
          <h2 class="text-lg font-medium mb-2">Crea un nuovo personaggio</h2>
          <p class="text-sm text-slate-300">
            Apri una nuova scheda vuota e inizia a compilarla.
          </p>
        </button>

        <button id="btnStartLoad"
                class="rounded-2xl border border-indigo-500 bg-slate-800/60 px-5 py-6 text-left hover:bg-slate-700 transition">
          <h2 class="text-lg font-medium mb-2">Carica un personaggio esistente</h2>
          <p class="text-sm text-slate-300">
            Recupera una scheda salvata nel browser o da un file esportato.
          </p>
        </button>
      </div>

      <p id="noCharactersMsg" class="mt-6 text-sm text-amber-300 hidden">
        Non sono ancora presenti personaggi salvati in questo browser. Puoi importare un file oppure creare una nuova scheda.
      </p>
    </section>

    <!-- Sheet screen -->
    <section id="sheetScreen" class="hidden">
      <!-- Top toolbar -->
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-4">
        <div class="flex flex-wrap items-center gap-2">
          <button id="btnBackToStart"
                  class="text-xs px-3 py-1 rounded-full border border-slate-600 hover:bg-slate-800">
            ← Torna alla scelta iniziale
          </button>
          <span class="text-xs text-slate-400">I dati sono salvati solo in questo browser.</span>
        </div>

        <div class="flex flex-wrap gap-2 items-center">
          <select id="characterList"
                  class="text-sm bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 min-w-[180px]">
            <option value="">– Seleziona personaggio –</option>
          </select>
          <button id="btnLoadSelected"
                  class="text-sm px-3 py-2 rounded-xl border border-slate-600 hover:bg-slate-800">
            Carica selezionato
          </button>
          <button id="btnNew"
                  class="text-sm px-3 py-2 rounded-xl border border-slate-600 hover:bg-slate-800">
            Nuova scheda
          </button>
          <button id="btnSave"
                  class="text-sm px-3 py-2 rounded-xl border border-emerald-500 bg-emerald-500/90 hover:bg-emerald-500">
            Salva scheda
          </button>
        </div>
      </div>

      <!-- Card container -->
      <div class="bg-slate-950/80 border border-slate-800 rounded-2xl shadow-lg shadow-slate-950/40 p-5 mb-6">
        <form id="characterForm" class="space-y-6">
          <!-- Titolo scheda -->
          <section class="border-b border-slate-800 pb-4">
            <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
              <div>
                <h2 class="text-xl md:text-2xl font-semibold tracking-wide">
                  Scheda del personaggio
                </h2>
                <p class="text-xs text-slate-400">
                  Compila tutti i campi per avere la tua scheda completa.
                </p>
              </div>
              <div class="flex flex-wrap gap-3">
                <div class="flex flex-col gap-1 min-w-[180px]">
                  <label for="characterName" class="text-xs font-medium text-slate-300 uppercase tracking-wide">
                    Nome personaggio *
                  </label>
                  <input id="characterName" name="characterName" required
                         class="text-sm rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                         placeholder="Es. Albert Crowe" />
                </div>
              </div>
            </div>
          </section>

          <!-- Trama (4 campi) -->
          <section>
            <h3 class="text-sm font-semibold text-slate-200 mb-2 tracking-wide uppercase">Trama</h3>
            <div class="grid gap-4 md:grid-cols-4">
              <div class="flex flex-col gap-1">
                <label for="tramaCulture" class="text-xs font-medium text-slate-300 uppercase tracking-wide">
                  Cultura
                </label>
                <input id="tramaCulture" name="tramaCulture"
                       class="text-sm rounded-xl bg-slate-900 border border-slate-700 px-3 py-2"
                       placeholder="Origine culturale, ambiente..." />
              </div>
              <div class="flex flex-col gap-1">
                <label for="tramaRole" class="text-xs font-medium text-slate-300 uppercase tracking-wide">
                  Ruolo
                </label>
                <input id="tramaRole" name="tramaRole"
                       class="text-sm rounded-xl bg-slate-900 border border-slate-700 px-3 py-2"
                       placeholder="Funzione nella storia, archetipo..." />
              </div>
              <div class="flex flex-col gap-1">
                <label for="tramaAwakening" class="text-xs font-medium text-slate-300 uppercase tracking-wide">
                  Risveglio
                </label>
                <input id="tramaAwakening" name="tramaAwakening"
                       class="text-sm rounded-xl bg-slate-900 border border-slate-700 px-3 py-2"
                       placeholder="Come ha scoperto i poteri, evento chiave..." />
              </div>
              <div class="flex flex-col gap-1">
                <label for="tramaTraining" class="text-xs font-medium text-slate-300 uppercase tracking-wide">
                  Formazione
                </label>
                <input id="tramaTraining" name="tramaTraining"
                       class="text-sm rounded-xl bg-slate-900 border border-slate-700 px-3 py-2"
                       placeholder="Addestramento, studi, mentori..." />
              </div>
            </div>
          </section>

          <!-- Trionfi (4 textbox) -->
          <section>
            <h3 class="text-sm font-semibold text-slate-200 mb-2 tracking-wide uppercase">Trionfi</h3>
            <div class="grid gap-4 md:grid-cols-4">
              <div class="flex flex-col gap-1">
                <label for="triumphIdentity" class="text-xs font-medium text-slate-300 uppercase tracking-wide">
                  Identità
                </label>
                <input id="triumphIdentity" name="triumphIdentity"
                       class="text-sm rounded-xl bg-slate-900 border border-slate-700 px-3 py-2"
                       placeholder="" />
              </div>
              <div class="flex flex-col gap-1">
                <label for="triumphPresent" class="text-xs font-medium text-slate-300 uppercase tracking-wide">
                  Presente
                </label>
                <input id="triumphPresent" name="triumphPresent"
                       class="text-sm rounded-xl bg-slate-900 border border-slate-700 px-3 py-2"
                       placeholder="" />
              </div>
              <div class="flex flex-col gap-1">
                <label for="triumphPast" class="text-xs font-medium text-slate-300 uppercase tracking-wide">
                  Passato
                </label>
                <input id="triumphPast" name="triumphPast"
                       class="text-sm rounded-xl bg-slate-900 border border-slate-700 px-3 py-2"
                       placeholder="" />
              </div>
              <div class="flex flex-col gap-1">
                <label for="triumphFuture" class="text-xs font-medium text-slate-300 uppercase tracking-wide">
                  Futuro
                </label>
                <input id="triumphFuture" name="triumphFuture"
                       class="text-sm rounded-xl bg-slate-900 border border-slate-700 px-3 py-2"
                       placeholder="" />
              </div>
            </div>
          </section>

          <!-- Bloccone 3 colonne -->
          <section>
            <!-- titolo sezione solo mobile -->
            <h3 class="text-sm font-semibold text-slate-200 mb-3 tracking-wide uppercase">
              Attributi &amp; Statistiche
            </h3>

            <!-- NUOVO LAYOUT: grid responsiva -->
            <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-[1fr_4fr_1fr] xl:grid-cols-[1fr_3fr_1fr]">
              <!-- Colonna sinistra: Protezione / Sovraccarico / Fortuna + Vantaggi -->
              <div class="space-y-3 order-2 md:order-2 lg:order-1 lg:col-span-1 lg:col-start-1">
                <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-3">
                  <div class="space-y-2">
                    <div class="flex items-center justify-between gap-2">
                      <label for="statProtection" class="text-xs text-slate-300 uppercase tracking-wide">Protezione</label>
                      <input id="statProtection" name="statProtection" type="number" inputmode="numeric"
                             class="w-16 text-center text-sm rounded-lg bg-slate-950 border border-slate-700 px-2 py-1" />
                    </div>
                    <div class="flex items-center justify-between gap-2">
                      <label for="statOverload" class="text-xs text-slate-300 uppercase tracking-wide">Sovraccarico</label>
                      <input id="statOverload" name="statOverload" type="number" inputmode="numeric"
                             class="w-16 text-center text-sm rounded-lg bg-slate-950 border border-slate-700 px-2 py-1" />
                    </div>
                    <div class="flex items-center justify-between gap-2">
                      <label for="statLuck" class="text-xs text-slate-300 uppercase tracking-wide">Fortuna</label>
                      <input id="statLuck" name="statLuck" type="number" inputmode="numeric"
                             class="w-16 text-center text-sm rounded-lg bg-slate-950 border border-slate-700 px-2 py-1" />
                    </div>
                  </div>

                  <!-- Vantaggi sotto risorse, separati da lineetta -->
                  <div class="mt-4 border-t border-slate-800 pt-3">
                    <div class="flex items-center justify-between gap-2">
                      <label for="advantages" class="text-xs text-slate-300 uppercase tracking-wide">
                        Vantaggi
                      </label>
                      <input id="advantages" name="advantages" type="number" inputmode="numeric"
                             class="w-16 text-center text-sm rounded-lg bg-slate-950 border border-slate-700 px-2 py-1" />
                    </div>
                  </div>
                </div>
              </div>

              <!-- Colonna centrale: 4 attributi + 12 stat -->
              <div class="space-y-3 order-1 md:order-1 lg:order-2 md:col-span-2 lg:col-span-1 lg:col-start-2">
                <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-3">
                  <!-- titolo attributi/statistiche solo mobile -->
                  <h4 class="text-xs font-semibold uppercase tracking-wide text-slate-300 mb-3 lg:hidden">
                    Attributi principali
                  </h4>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                    <div class="flex flex-col items-center gap-1">
                      <span class="text-[11px] uppercase tracking-wide text-slate-300">Corpo</span>
                      <input id="attrBody" name="attrBody" type="number" inputmode="numeric"
                             class="w-16 text-center text-sm rounded-full bg-slate-950 border border-slate-700 px-2 py-1" />
                    </div>
                    <div class="flex flex-col items-center gap-1">
                      <span class="text-[11px] uppercase tracking-wide text-slate-300">Mente</span>
                      <input id="attrMind" name="attrMind" type="number" inputmode="numeric"
                             class="w-16 text-center text-sm rounded-full bg-slate-950 border border-slate-700 px-2 py-1" />
                    </div>
                    <div class="flex flex-col items-center gap-1">
                      <span class="text-[11px] uppercase tracking-wide text-slate-300">Cuore</span>
                      <input id="attrHeart" name="attrHeart" type="number" inputmode="numeric"
                             class="w-16 text-center text-sm rounded-full bg-slate-950 border border-slate-700 px-2 py-1" />
                    </div>
                    <div class="flex flex-col items-center gap-1">
                      <span class="text-[11px] uppercase tracking-wide text-slate-300">Spirito</span>
                      <input id="attrSpirit" name="attrSpirit" type="number" inputmode="numeric"
                             class="w-16 text-center text-sm rounded-full bg-slate-950 border border-slate-700 px-2 py-1" />
                    </div>
                  </div>

                  <!-- titolo statistiche solo mobile -->
                  <h4 class="text-xs font-semibold uppercase tracking-wide text-slate-300 mb-2 lg:hidden">
                    Statistiche
                  </h4>

                  <!-- 4 blocchi: 3 stat sotto ogni attributo -->
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <!-- Corpo -->
                    <div class="space-y-1">
                      <h5 class="text-[11px] uppercase tracking-wide text-slate-400 text-center md:text-left md:hidden">Corpo</h5>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statAthletics" class="text-[11px] text-slate-300 uppercase tracking-wide">Atletica</label>
                        <input id="statAthletics" name="statAthletics" type="number" inputmode="numeric"
                               class="w-14 text-center text-sm rounded-lg bg-slate-950 border border-slate-700 px-2 py-1" />
                      </div>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statDexterity" class="text-[11px] text-slate-300 uppercase tracking-wide">Destrezza</label>
                        <input id="statDexterity" name="statDexterity" type="number" inputmode="numeric"
                               class="w-14 text-center text-sm rounded-lg bg-slate-950 border border-slate-700 px-2 py-1" />
                      </div>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statCommand" class="text-[11px] text-slate-300 uppercase tracking-wide">Comando</label>
                        <input id="statCommand" name="statCommand" type="number" inputmode="numeric"
                               class="w-14 text-center text-sm rounded-lg bg-slate-950 border border-slate-700 px-2 py-1" />
                      </div>
                    </div>

                    <!-- Mente -->
                    <div class="space-y-1 border-l border-slate-800 pl-3">
                      <h5 class="text-[11px] uppercase tracking-wide text-slate-400 text-center md:text-left md:hidden">Mente</h5>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statAnalysis" class="text-[11px] text-slate-300 uppercase tracking-wide">Analisi</label>
                        <input id="statAnalysis" name="statAnalysis" type="number" inputmode="numeric"
                               class="w-14 text-center text-sm rounded-lg bg-slate-950 border border-slate-700 px-2 py-1" />
                      </div>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statKnowledge" class="text-[11px] text-slate-300 uppercase tracking-wide">Conoscenza</label>
                        <input id="statKnowledge" name="statKnowledge" type="number" inputmode="numeric"
                               class="w-14 text-center text-sm rounded-lg bg-slate-950 border border-slate-700 px-2 py-1" />
                      </div>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statCharm" class="text-[11px] text-slate-300 uppercase tracking-wide">Fascino</label>
                        <input id="statCharm" name="statCharm" type="number" inputmode="numeric"
                               class="w-14 text-center text-sm rounded-lg bg-slate-950 border border-slate-700 px-2 py-1" />
                      </div>
                    </div>

                    <!-- Cuore -->
                    <div class="space-y-1 md:border-l md:border-slate-800 md:pl-3">
                      <h5 class="text-[11px] uppercase tracking-wide text-slate-400 text-center md:text-left md:hidden">Cuore</h5>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statStealth" class="text-[11px] text-slate-300 uppercase tracking-wide">Sotterfugio</label>
                        <input id="statStealth" name="statStealth" type="number" inputmode="numeric"
                               class="w-14 text-center text-sm rounded-lg bg-slate-950 border border-slate-700 px-2 py-1" />
                      </div>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statSurvival" class="text-[11px] text-slate-300 uppercase tracking-wide">Sopravvivenza</label>
                        <input id="statSurvival" name="statSurvival" type="number" inputmode="numeric"
                               class="w-14 text-center text-sm rounded-lg bg-slate-950 border border-slate-700 px-2 py-1" />
                      </div>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statInsight" class="text-[11px] text-slate-300 uppercase tracking-wide">Intuizione</label>
                        <input id="statInsight" name="statInsight" type="number" inputmode="numeric"
                               class="w-14 text-center text-sm rounded-lg bg-slate-950 border border-slate-700 px-2 py-1" />
                      </div>
                    </div>

                    <!-- Spirito -->
                    <div class="space-y-1 border-l border-slate-800 pl-3">
                      <h5 class="text-[11px] uppercase tracking-wide text-slate-400 text-center md:text-left md:hidden">Spirito</h5>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statPower" class="text-[11px] text-slate-300 uppercase tracking-wide">Potenza</label>
                        <input id="statPower" name="statPower" type="number" inputmode="numeric"
                               class="w-14 text-center text-sm rounded-lg bg-slate-950 border border-slate-700 px-2 py-1" />
                      </div>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statControl" class="text-[11px] text-slate-300 uppercase tracking-wide">Controllo</label>
                        <input id="statControl" name="statControl" type="number" inputmode="numeric"
                               class="w-14 text-center text-sm rounded-lg bg-slate-950 border border-slate-700 px-2 py-1" />
                      </div>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statPerception" class="text-[11px] text-slate-300 uppercase tracking-wide">Percezione</label>
                        <input id="statPerception" name="statPerception" type="number" inputmode="numeric"
                               class="w-14 text-center text-sm rounded-lg bg-slate-950 border border-slate-700 px-2 py-1" />
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Colonna destra: Vitalità / Resistenza / Caos + Esperienza -->
              <div class="space-y-3 order-3 md:order-3 lg:order-3 lg:col-span-1 lg:col-start-3">
                <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-3">
                  <div class="space-y-2">
                    <div class="flex items-center justify-between gap-2">
                      <label for="statVitality" class="text-xs text-slate-300 uppercase tracking-wide">Vitalità</label>
                      <input id="statVitality" name="statVitality" type="number" inputmode="numeric"
                             class="w-16 text-center text-sm rounded-lg bg-slate-950 border border-slate-700 px-2 py-1" />
                    </div>
                    <div class="flex items-center justify-between gap-2">
                      <label for="statStamina" class="text-xs text-slate-300 uppercase tracking-wide">Resistenza</label>
                      <input id="statStamina" name="statStamina" type="number" inputmode="numeric"
                             class="w-16 text-center text-sm rounded-lg bg-slate-950 border border-slate-700 px-2 py-1" />
                    </div>
                    <div class="flex items-center justify-between gap-2">
                      <label for="statChaos" class="text-xs text-slate-300 uppercase tracking-wide">Caos</label>
                      <input id="statChaos" name="statChaos" type="number" inputmode="numeric"
                             class="w-16 text-center text-sm rounded-lg bg-slate-950 border border-slate-700 px-2 py-1" />
                    </div>
                  </div>

                  <!-- Esperienza -->
                  <div class="mt-4 border-t border-slate-800 pt-3">
                    <div class="flex items-center justify-between gap-2">
                      <label for="experience" class="text-xs text-slate-300 uppercase tracking-wide">Esperienza</label>
                      <input id="experience" name="experience" type="number" inputmode="numeric"
                             class="w-16 text-center text-sm rounded-lg bg-slate-950 border border-slate-700 px-2 py-1" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Condizioni -->
          <section>
            <label for="conditions" class="text-xs font-medium text-slate-300 uppercase tracking-wide block mb-1">
              Condizioni
            </label>

            <textarea id="conditions" name="conditions" rows="2"
                      class="w-full text-sm rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 resize-y"
                      placeholder="Ferite, stati mentali, maledizioni..."></textarea>
          </section>

          <!-- Discipline -->
          <section>
            <h3 class="text-sm font-semibold text-slate-200 mb-2 tracking-wide uppercase">
              Discipline
            </h3>

            <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4 space-y-4">
              <!-- Nomi discipline orizzontali -->
              <div class="flex flex-wrap gap-2">
                <button type="button"
                        class="discipline-tab text-xs sm:text-sm px-3 py-1.5 rounded-full border border-slate-600 bg-slate-950/60 hover:bg-slate-800 transition"
                        data-discipline-target="disc-acqua-panel">
                  Acqua
                </button>
                <button type="button"
                        class="discipline-tab text-xs sm:text-sm px-3 py-1.5 rounded-full border border-slate-600 bg-slate-950/60 hover:bg-slate-800 transition"
                        data-discipline-target="disc-aria-panel">
                  Aria
                </button>
                <button type="button"
                        class="discipline-tab text-xs sm:text-sm px-3 py-1.5 rounded-full border border-slate-600 bg-slate-950/60 hover:bg-slate-800 transition"
                        data-discipline-target="disc-fuoco-panel">
                  Fuoco
                </button>
                <button type="button"
                        class="discipline-tab text-xs sm:text-sm px-3 py-1.5 rounded-full border border-slate-600 bg-slate-950/60 hover:bg-slate-800 transition"
                        data-discipline-target="disc-terra-panel">
                  Terra
                </button>
                <button type="button"
                        class="discipline-tab text-xs sm:text-sm px-3 py-1.5 rounded-full border border-slate-600 bg-slate-950/60 hover:bg-slate-800 transition"
                        data-discipline-target="disc-luce-panel">
                  Luce
                </button>
                <button type="button"
                        class="discipline-tab text-xs sm:text-sm px-3 py-1.5 rounded-full border border-slate-600 bg-slate-950/60 hover:bg-slate-800 transition"
                        data-discipline-target="disc-vita-panel">
                  Vita
                </button>
                <button type="button"
                        class="discipline-tab text-xs sm:text-sm px-3 py-1.5 rounded-full border border-slate-600 bg-slate-950/60 hover:bg-slate-800 transition"
                        data-discipline-target="disc-natura-panel">
                  Natura
                </button>
                <button type="button"
                        class="discipline-tab text-xs sm:text-sm px-3 py-1.5 rounded-full border border-slate-600 bg-slate-950/60 hover:bg-slate-800 transition"
                        data-discipline-target="disc-spirito-panel">
                  Spirito
                </button>
                <button type="button"
                        class="discipline-tab text-xs sm:text-sm px-3 py-1.5 rounded-full border border-slate-600 bg-slate-950/60 hover:bg-slate-800 transition"
                        data-discipline-target="disc-oscurita-panel">
                  Oscurità
                </button>
                <button type="button"
                        class="discipline-tab text-xs sm:text-sm px-3 py-1.5 rounded-full border border-slate-600 bg-slate-950/60 hover:bg-slate-800 transition"
                        data-discipline-target="disc-spazio-panel">
                  Spazio
                </button>
                <button type="button"
                        class="discipline-tab text-xs sm:text-sm px-3 py-1.5 rounded-full border border-slate-600 bg-slate-950/60 hover:bg-slate-800 transition"
                        data-discipline-target="disc-tempo-panel">
                  Tempo
                </button>
              </div>

              <!-- Pannelli accordion -->
              <div class="space-y-3">
                <!-- Acqua (2 lezioni) -->
                <div id="disc-acqua-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <!-- Title of the opened discipline -->
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    ACQUA
                  </h4>
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discAcquaLesson1" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discAcquaLesson2" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 2</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discAcquaGrade" type="number" inputmode="numeric"
                            class="w-16 text-center text-sm rounded-lg bg-slate-900 border border-slate-700 px-2 py-1" />
                    </div>
                  </div>
                </div>

                <!-- Aria (2 lezioni) -->
                <div id="disc-aria-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <!-- Title of the opened discipline -->
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    ARIA
                  </h4>
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discAriaLesson1" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discAriaLesson2" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 2</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discAriaGrade" type="number" inputmode="numeric"
                            class="w-16 text-center text-sm rounded-lg bg-slate-900 border border-slate-700 px-2 py-1" />
                    </div>
                  </div>
                </div>

                <!-- Fuoco (2 lezioni) -->
                <div id="disc-fuoco-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <!-- Title of the opened discipline -->
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    FUOCO
                  </h4>                
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discFuocoLesson1" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discFuocoLesson2" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 2</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discFuocoGrade" type="number" inputmode="numeric"
                            class="w-16 text-center text-sm rounded-lg bg-slate-900 border border-slate-700 px-2 py-1" />
                    </div>
                  </div>
                </div>

                <!-- Terra (2 lezioni) -->
                <div id="disc-terra-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <!-- Title of the opened discipline -->
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    TERRA
                  </h4>                
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discTerraLesson1" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discTerraLesson2" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 2</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discTerraGrade" type="number" inputmode="numeric"
                            class="w-16 text-center text-sm rounded-lg bg-slate-900 border border-slate-700 px-2 py-1" />
                    </div>
                  </div>
                </div>

                <!-- Luce (2 lezioni) -->
                <div id="disc-luce-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <!-- Title of the opened discipline -->
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    LUCE
                  </h4>                
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discLuceLesson1" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discLuceLesson2" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 2</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discLuceGrade" type="number" inputmode="numeric"
                            class="w-16 text-center text-sm rounded-lg bg-slate-900 border border-slate-700 px-2 py-1" />
                    </div>
                  </div>
                </div>

                <!-- Vita (3 lezioni) -->
                <div id="disc-vita-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <!-- Title of the opened discipline -->
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    VITA
                  </h4>                
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discVitaLesson1" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discVitaLesson2" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 2</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discVitaLesson3" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 3</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discVitaGrade" type="number" inputmode="numeric"
                            class="w-16 text-center text-sm rounded-lg bg-slate-900 border border-slate-700 px-2 py-1" />
                    </div>
                  </div>
                </div>

                <!-- Natura (3 lezioni) -->
                <div id="disc-natura-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <!-- Title of the opened discipline -->
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    NATURA
                  </h4>                
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discNaturaLesson1" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discNaturaLesson2" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 2</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discNaturaLesson3" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 3</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discNaturaGrade" type="number" inputmode="numeric"
                            class="w-16 text-center text-sm rounded-lg bg-slate-900 border border-slate-700 px-2 py-1" />
                    </div>
                  </div>
                </div>

                <!-- Spirito (3 lezioni) -->
                <div id="disc-spirito-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <!-- Title of the opened discipline -->
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    SPIRITO
                  </h4>                
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discSpiritoLesson1" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discSpiritoLesson2" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 2</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discSpiritoLesson3" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 3</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discSpiritoGrade" type="number" inputmode="numeric"
                            class="w-16 text-center text-sm rounded-lg bg-slate-900 border border-slate-700 px-2 py-1" />
                    </div>
                  </div>
                </div>

                <!-- Oscurità (3 lezioni) -->
                <div id="disc-oscurita-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <!-- Title of the opened discipline -->
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    OSCURITÀ
                  </h4>                
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discOscuritaLesson1" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discOscuritaLesson2" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 2</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discOscuritaLesson3" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 3</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discOscuritaGrade" type="number" inputmode="numeric"
                            class="w-16 text-center text-sm rounded-lg bg-slate-900 border border-slate-700 px-2 py-1" />
                    </div>
                  </div>
                </div>

                <!-- Spazio (4 lezioni) -->
                <div id="disc-spazio-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <!-- Title of the opened discipline -->
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    SPAZIO
                  </h4>              
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discSpazioLesson1" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discSpazioLesson2" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 2</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discSpazioLesson3" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 3</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discSpazioLesson4" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 4</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discSpazioGrade" type="number" inputmode="numeric"
                            class="w-16 text-center text-sm rounded-lg bg-slate-900 border border-slate-700 px-2 py-1" />
                    </div>
                  </div>
                </div>

                <!-- Tempo (4 lezioni) -->
                <div id="disc-tempo-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <!-- Title of the opened discipline -->
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    TEMPO
                  </h4>                
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discTempoLesson1" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discTempoLesson2" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 2</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discTempoLesson3" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 3</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discTempoLesson4" type="checkbox"
                              class="w-4 h-4 rounded border-slate-500 bg-slate-950">
                        <span>Lezione 4</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discTempoGrade" type="number" inputmode="numeric"
                            class="w-16 text-center text-sm rounded-lg bg-slate-900 border border-slate-700 px-2 py-1" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>


          <!-- Equipaggiamento -->
          <section>
            <h3 class="text-sm font-semibold text-slate-200 mb-2 tracking-wide uppercase">
              Equipaggiamento
            </h3>
            <div class="grid gap-4 md:grid-cols-2">
              <div class="flex flex-col gap-1">
                <label for="equipWeaponsSpells" class="text-xs font-medium text-slate-300 uppercase tracking-wide">
                  Armi e Incantesimi
                </label>
                <textarea id="equipWeaponsSpells" name="equipWeaponsSpells" rows="4"
                          class="text-sm rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 resize-y"
                          placeholder="- Arma / incantesimo&#10;- Danno / effetto&#10;- Note..."></textarea>
              </div>
              <div class="flex flex-col gap-1">
                <label for="equipAccessories" class="text-xs font-medium text-slate-300 uppercase tracking-wide">
                  Accessori
                </label>
                <textarea id="equipAccessories" name="equipAccessories" rows="4"
                          class="text-sm rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 resize-y"
                          placeholder="- Anelli, amuleti, talismani&#10;- Effetti passivi..."></textarea>
              </div>
              <div class="flex flex-col gap-1">
                <label for="equipTools" class="text-xs font-medium text-slate-300 uppercase tracking-wide">
                  Strumenti
                </label>
                <textarea id="equipTools" name="equipTools" rows="4"
                          class="text-sm rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 resize-y"
                          placeholder="- Kit, attrezzi, focus rituali..."></textarea>
              </div>
              <div class="flex flex-col gap-1">
                <label for="equipOther" class="text-xs font-medium text-slate-300 uppercase tracking-wide">
                  Altro Equipaggiamento
                </label>
                <textarea id="equipOther" name="equipOther" rows="4"
                          class="text-sm rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 resize-y"
                          placeholder="- Oggetti vari, bottino, risorse..."></textarea>
              </div>
              <div class="flex flex-col gap-1 md:col-span-2">
                <label for="equipLoot" class="text-xs font-medium text-slate-300 uppercase tracking-wide">
                  Bottino
                </label>
                <textarea id="equipLoot" name="equipLoot" rows="3"
                          class="text-sm rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 resize-y"
                          placeholder="- Tesori, premi, ricompense..."></textarea>
              </div>
            </div>
          </section>

          <!-- Influenze -->
          <section>
            <h3 class="text-sm font-semibold text-slate-200 mb-2 tracking-wide uppercase">
              Influenze
            </h3>
            <textarea id="influences" name="influences" rows="4"
                      class="w-full text-sm rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 resize-y"
                      placeholder="Fazioni, contatti, patroni, debiti, favori..."></textarea>

            <div class="mt-3 flex flex-col gap-1 w-full">
              <label for="reputation" class="text-xs font-medium text-slate-300 uppercase tracking-wide">
                Reputazione
              </label>
              <input id="reputation" name="reputation"
                     class="w-full text-sm rounded-xl bg-slate-900 border border-slate-700 px-3 py-2"
                     placeholder="Come è visto il personaggio, fama, infamia..." />
            </div>
          </section>

          <!-- Arti e Poteri -->
          <section>
            <h3 class="text-sm font-semibold text-slate-200 mb-2 tracking-wide uppercase">
              Arti e Poteri
            </h3>
            <textarea id="artsPowers" name="artsPowers" rows="5"
                      class="w-full text-sm rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 resize-y"
                      placeholder="Descrivi le Arti e i Poteri del personaggio, effetti, costi, limitazioni..."></textarea>
          </section>

          <!-- Note -->
          <section>
            <h3 class="text-sm font-semibold text-slate-200 mb-2 tracking-wide uppercase">
              Note
            </h3>
            <textarea id="notes" name="notes" rows="5"
                      class="w-full text-sm rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 resize-y"
                      placeholder="Appunti di sessione, idee future, promemoria per il Cronista..."></textarea>
          </section>
        </form>
      </div>

      <!-- Bottom action bar -->
      <div class="flex flex-wrap gap-2 justify-end">
        <button id="btnNewBottom"
                class="text-sm px-3 py-2 rounded-xl border border-slate-600 hover:bg-slate-800">
          Crea nuova scheda
        </button>
        <button id="btnSaveBottom"
                class="text-sm px-3 py-2 rounded-xl border border-emerald-500 bg-emerald-500/90 hover:bg-emerald-500">
          Salva scheda
        </button>
      </div>
    </section>
  </div>

  <script>
    // -----------------------------
    // Storage helpers (no CRUD in loops)
    // -----------------------------
    const STORAGE_KEY = "arcanist_characters_v1";

    function loadAllCharacters() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        return {};
      }
      try {
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === "object" ? parsed : {};
      } catch (e) {
        console.error("Error parsing characters from storage", e);
        return {};
      }
    }

    function saveAllCharacters(characters) {
      const serialized = JSON.stringify(characters);
      localStorage.setItem(STORAGE_KEY, serialized);
    }

    // -----------------------------
    // UI state
    // -----------------------------
    const startScreen = document.getElementById("startScreen");
    const sheetScreen = document.getElementById("sheetScreen");
    const characterForm = document.getElementById("characterForm");
    const characterList = document.getElementById("characterList");
    const noCharactersMsg = document.getElementById("noCharactersMsg");

    const btnStartNew = document.getElementById("btnStartNew");
    const btnStartLoad = document.getElementById("btnStartLoad");
    const btnBackToStart = document.getElementById("btnBackToStart");

    const btnNew = document.getElementById("btnNew");
    const btnSave = document.getElementById("btnSave");
    const btnLoadSelected = document.getElementById("btnLoadSelected");
    const btnExport = document.getElementById("btnExport");
    const btnImport = document.getElementById("btnImport");
    const importInput = document.getElementById("importInput");

    const btnNewBottom = document.getElementById("btnNewBottom");
    const btnSaveBottom = document.getElementById("btnSaveBottom");

    const characterNameInput = document.getElementById("characterName");

    let currentCharacterId = null;

    // -----------------------------
    // Screen navigation
    // -----------------------------
    function showStartScreen() {
      startScreen.classList.remove("hidden");
      sheetScreen.classList.add("hidden");
      refreshStartScreenMessage();
    }

    function showSheetScreen() {
      startScreen.classList.add("hidden");
      sheetScreen.classList.remove("hidden");
      refreshCharacterList();
    }

    function refreshStartScreenMessage() {
      const characters = loadAllCharacters();
      const hasCharacters = Object.keys(characters).length > 0;
      noCharactersMsg.classList.toggle("hidden", hasCharacters);
    }

    // -----------------------------
    // Form <-> data mapping
    // -----------------------------
    const FIELD_IDS = [
      "characterName",
      // --- Trama ---
      "tramaCulture",
      "tramaRole",
      "tramaAwakening",
      "tramaTraining",
      // --- Trionfi ---
      "triumphIdentity",
      "triumphPresent",
      "triumphPast",
      "triumphFuture",
      // --- Main Attributes ---
      "attrBody",
      "attrMind",
      "attrHeart",
      "attrSpirit",
      // --- Main Statistics (12) ---
      "statAthletics",
      "statDexterity",
      "statCommand",
      "statAnalysis",
      "statKnowledge",
      "statCharm",
      "statStealth",
      "statSurvival",
      "statInsight",
      "statPower",
      "statControl",
      "statPerception",
      // --- Secondary Statistics (6) ---
      "statProtection",
      "statOverload",
      "statLuck",
      "statVitality",
      "statStamina",
      "statChaos",
      // --- Advantages / XP / Conditions ---
      "advantages",
      "experience",
      "conditions",
      // --- Discipline: Acqua ---
      "discAcquaLesson1",
      "discAcquaLesson2",
      "discAcquaGrade",
      // --- Discipline: Aria ---
      "discAriaLesson1",
      "discAriaLesson2",
      "discAriaGrade",
      // --- Discipline: Fuoco ---
      "discFuocoLesson1",
      "discFuocoLesson2",
      "discFuocoGrade",
      // --- Discipline: Terra ---
      "discTerraLesson1",
      "discTerraLesson2",
      "discTerraGrade",
      // --- Discipline: Luce ---
      "discLuceLesson1",
      "discLuceLesson2",
      "discLuceGrade",
      // --- Discipline: Vita ---
      "discVitaLesson1",
      "discVitaLesson2",
      "discVitaLesson3",
      "discVitaGrade",
      // --- Discipline: Natura ---
      "discNaturaLesson1",
      "discNaturaLesson2",
      "discNaturaLesson3",
      "discNaturaGrade",
      // --- Discipline: Spirito ---
      "discSpiritoLesson1",
      "discSpiritoLesson2",
      "discSpiritoLesson3",
      "discSpiritoGrade",
      // --- Discipline: Oscurità ---
      "discOscuritaLesson1",
      "discOscuritaLesson2",
      "discOscuritaLesson3",
      "discOscuritaGrade",
      // --- Discipline: Spazio ---
      "discSpazioLesson1",
      "discSpazioLesson2",
      "discSpazioLesson3",
      "discSpazioLesson4",
      "discSpazioGrade",
      // --- Discipline: Tempo ---
      "discTempoLesson1",
      "discTempoLesson2",
      "discTempoLesson3",
      "discTempoLesson4",
      "discTempoGrade",
      // --- Equipment ---
      "equipWeaponsSpells",
      "equipAccessories",
      "equipTools",
      "equipOther",
      "equipLoot",
      // --- Influences & Reputation ---
      "influences",
      "reputation",
      // --- Arts & Powers ---
      "artsPowers",
      // --- Notes ---
      "notes"
    ];

    function forEachField(callback) {
      FIELD_IDS.forEach((id) => {
        const el = document.getElementById(id);
        if (el) callback(el, id);
      });
    }

    function getFormData() {
      const data = {};
      forEachField((el, id) => {
        if (el.type === "checkbox") {
          data[id] = el.checked;
        } else {
          data[id] = el.value;
        }
      });
      return data;
    }

    function setFormData(data = {}) {
      forEachField((el, id) => {
        if (el.type === "checkbox") {
          el.checked = Boolean(data[id]);
        } else {
          el.value = data[id] ?? "";
        }
      });
    }

    function clearForm() {
      setFormData({});
      currentCharacterId = null;
      updateExportButtonState();
    }

    // -----------------------------
    // Discipline accordion
    // -----------------------------
    const disciplineTabs = document.querySelectorAll(".discipline-tab");
    const disciplinePanels = document.querySelectorAll("[data-discipline-panel]");

    disciplineTabs.forEach((btn) => {
      btn.addEventListener("click", () => {
        const targetId = btn.getAttribute("data-discipline-target");
        const panel = document.getElementById(targetId);
        if (!panel) {
          return;
        }

        const isHidden = panel.classList.contains("hidden");
        if (isHidden) {
          panel.classList.remove("hidden");
          btn.classList.add("bg-slate-800");
        } else {
          panel.classList.add("hidden");
          btn.classList.remove("bg-slate-800");
        }
      });
    });

    // -----------------------------
    // Character list management
    // -----------------------------
    function createCharacterIdFromName(name) {
      const normalized = (name || "").trim().toLowerCase();
      if (!normalized) {
        return null;
      }
      return normalized
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "")
        .slice(0, 60) || null;
    }

    function refreshCharacterList() {
      const characters = loadAllCharacters();
      const ids = Object.keys(characters).sort();

      characterList.innerHTML = '<option value="">– Seleziona personaggio –</option>';

      ids.forEach((id) => {
        const option = document.createElement("option");
        const name = characters[id]?.characterName || id;
        option.value = id;
        option.textContent = name;
        characterList.appendChild(option);
      });
    }

    function loadCharacterById(id) {
      if (!id) {
        return;
      }
      const characters = loadAllCharacters();
      const data = characters[id];
      if (!data) {
        alert("Personaggio non trovato, potrebbe essere stato rimosso.");
        refreshCharacterList();
        return;
      }
      currentCharacterId = id;
      setFormData(data);
      updateExportButtonState();
    }

    // -----------------------------
    // Save / New / Load
    // -----------------------------
    function handleNewCharacter() {
      clearForm();
      if (characterNameInput) {
        characterNameInput.focus();
      }
    }

    function handleSaveCharacter() {
      const data = getFormData();
      const name = (data.characterName || "").trim();

      if (!name) {
        alert("Inserisci almeno il nome del personaggio per poter salvare.");
        characterNameInput.focus();
        return;
      }

      let id = currentCharacterId || createCharacterIdFromName(name);
      if (!id) {
        alert("Nome non valido. Riprova con un nome diverso.");
        return;
      }

      const characters = loadAllCharacters();
      const isNew = !characters[id];

      if (!isNew && !currentCharacterId && !confirm("Esiste già un personaggio con questo nome. Sovrascrivere?")) {
        return;
      }

      characters[id] = data;
      saveAllCharacters(characters);
      currentCharacterId = id;
      refreshCharacterList();
      updateExportButtonState();
      alert("Scheda salvata nel browser.");
    }

    function handleLoadSelected() {
      const id = characterList.value;
      if (!id) {
        alert("Seleziona un personaggio dalla lista.");
        return;
      }
      loadCharacterById(id);
    }

    // -----------------------------
    // Export / Import
    // -----------------------------
    function updateExportButtonState() {
      const data = getFormData();
      const canExport = !!(data.characterName && data.characterName.trim());
      btnExport.disabled = !canExport;
    }

    function handleExport() {
      const data = getFormData();
      const nameSafe = (data.characterName || "personaggio")
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "") || "personaggio";
    
      // JSON come contenuto, ma salvato in .txt
      const payload = JSON.stringify(data, null, 2);
      const blob = new Blob([payload], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
    
      const a = document.createElement("a");
      a.href = url;
      a.download = `scheda-${nameSafe}.txt`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }


    function handleImportClick() {
      importInput.value = "";
      importInput.click();
    }

    function handleImportFileChange(event) {
      const file = event.target.files && event.target.files[0];
      if (!file) {
        return;
      }
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const text = String(e.target?.result || "");
          const parsed = JSON.parse(text);
          if (!parsed || typeof parsed !== "object") {
            alert("File non valido: il contenuto non è un JSON di scheda.");
            return;
          }
          setFormData(parsed);
          updateExportButtonState();

          const name = (parsed.characterName || "").trim();
          if (name) {
            const id = createCharacterIdFromName(name);
            if (id) {
              const characters = loadAllCharacters();
              characters[id] = parsed;
              saveAllCharacters(characters);
              currentCharacterId = id;
              refreshCharacterList();
            }
          }

          showSheetScreen();
          alert("Scheda importata correttamente.");
        } catch (err) {
          console.error(err);
          alert("Errore durante l'import: assicurati che il file sia stato esportato dall'app o sia un JSON valido.");
        }
      };
      reader.readAsText(file);
    }

    // -----------------------------
    // Events wiring
    // -----------------------------
    btnStartNew.addEventListener("click", () => {
      showSheetScreen();
      handleNewCharacter();
    });

    btnStartLoad.addEventListener("click", () => {
      const characters = loadAllCharacters();
      const hasCharacters = Object.keys(characters).length > 0;
      if (!hasCharacters) {
        refreshStartScreenMessage();
        alert("Nessun personaggio salvato in questo browser. Puoi importare una scheda da file.");
        handleImportClick();
      } else {
        showSheetScreen();
      }
    });

    btnBackToStart.addEventListener("click", () => {
      showStartScreen();
    });

    btnNew.addEventListener("click", handleNewCharacter);
    btnNewBottom.addEventListener("click", handleNewCharacter);

    btnSave.addEventListener("click", handleSaveCharacter);
    btnSaveBottom.addEventListener("click", handleSaveCharacter);

    btnLoadSelected.addEventListener("click", handleLoadSelected);

    btnExport.addEventListener("click", handleExport);
    btnImport.addEventListener("click", handleImportClick);
    importInput.addEventListener("change", handleImportFileChange);

    characterForm.addEventListener("input", () => {
      updateExportButtonState();
    });

    // -----------------------------
    // Initial setup
    // -----------------------------
    refreshStartScreenMessage();
    updateExportButtonState();
  </script>
</body>
</html>
