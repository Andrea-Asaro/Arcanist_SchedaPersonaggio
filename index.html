<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Scheda Arcanist - Web App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Fonts per look "tomo magico" -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=EB+Garamond:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {},
        screens: {
          sm: "640px",
          md: "768px",
          lg: "1250px",
          xl: "1450px",
        }
      }
    }
  </script>

  <style>
    :root {
      /* === Arcane color palette (facili da cambiare) === */
      --arcane-bg: #050313;
      --arcane-bg-accent: #1b102f;
      --arcane-page: #0f1020;
      --arcane-page-soft: #15152b;
      --arcane-border: #d6b37a;
      --arcane-border-soft: rgba(214, 179, 122, 0.55);
      --arcane-accent: #f0c46a;
      --arcane-accent-soft: rgba(240, 196, 106, 0.6);
      --arcane-accent-secondary: #7ddcff;
      --arcane-text-main: #f5f0e6;
      --arcane-text-muted: #c9c0b0;
      --arcane-rune-glow: rgba(125, 220, 255, 0.28);
    }

    /* --- Base layout: sfondo da tomo arcano, font di lettura --- */
    body {
      min-height: 100vh;
      background:
        radial-gradient(circle at top, rgba(148, 94, 255, 0.12), transparent 60%),
        radial-gradient(circle at bottom, rgba(0, 200, 180, 0.16), transparent 55%),
        radial-gradient(circle at center, var(--arcane-bg-accent), var(--arcane-bg) 60%);
      color: var(--arcane-text-main);
      font-family: "EB Garamond", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .hidden-input {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* --- Cornice esterna tipo tomo --- */
    .arcane-shell {
      position: relative;
      border-radius: 1.75rem;
    }

    .arcane-shell::before,
    .arcane-shell::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      pointer-events: none;
    }

    .arcane-shell::before {
      border: 1px solid rgba(255, 255, 255, 0.02);
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.9),
        0 18px 55px rgba(0, 0, 0, 0.85);
    }

    .arcane-shell::after {
      border: 1px solid rgba(240, 196, 106, 0.16);
      mix-blend-mode: screen;
    }

    /* --- Pagina principale della scheda --- */
    .arcane-page {
      position: relative;
      background:
        radial-gradient(circle at top, rgba(240, 196, 106, 0.13), transparent 60%),
        linear-gradient(135deg, rgba(12, 10, 24, 0.97), rgba(6, 7, 22, 0.98));
      border-radius: 1.5rem;
      border: 1px solid rgba(214, 179, 122, 0.35);
      box-shadow:
        0 0 0 1px rgba(2, 4, 16, 0.9),
        0 18px 40px rgba(0, 0, 0, 0.85);
      overflow: hidden;
    }

    .arcane-page::before {
      content: "☿ ✶ ☉ ✶ ☽";
      position: absolute;
      inset-inline: 2.5rem;
      top: 0.55rem;
      text-align: center;
      font-size: 0.55rem;
      letter-spacing: 0.5em;
      text-transform: uppercase;
      color: rgba(240, 196, 106, 0.45);
      pointer-events: none;
    }

    @media (max-width: 640px) {
      .arcane-page::before {
        inset-inline: 1.25rem;
        letter-spacing: 0.35em;
      }
    }

    /* --- Titolo libro magico --- */
    h1 {
      font-family: "Cinzel Decorative", "EB Garamond", serif;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--arcane-accent);
      text-shadow: 0 0 14px rgba(240, 196, 106, 0.45);
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.4rem;
    }

    h1::before,
    h1::after {
      content: "✶";
      font-size: 0.8rem;
      color: var(--arcane-accent-soft);
      text-shadow: 0 0 10px rgba(240, 196, 106, 0.6);
    }

    .arcane-subtitle {
      font-size: 0.7rem;
      letter-spacing: 0.35em;
      text-transform: uppercase;
      color: var(--arcane-text-muted);
    }

    /* --- Sezioni (Trama, Trionfi, ecc.) con linee mistiche --- */
    h3 {
      font-size: 0.75rem;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: var(--arcane-text-muted);
      display: flex;
      align-items: center;
      gap: 0.45rem;
      margin-bottom: 0.75rem;
    }

    h3::before,
    h3::after {
      content: "";
      flex: 1;
      height: 1px;
      background: linear-gradient(
        to right,
        transparent,
        rgba(240, 196, 106, 0.45),
        transparent
      );
      opacity: 0.7;
    }

    h3::before {
      max-width: 1.75rem;
    }

    h3::after {
      max-width: 2.5rem;
    }

    /* Mantieni testo della sezione centrato all'interno delle linee */
    h3 span {
      white-space: nowrap;
    }

    /* Etichette input */
    label {
      font-size: 0.7rem;
      letter-spacing: 0.19em;
      text-transform: uppercase;
      color: var(--arcane-text-muted);
    }

    /* --- Campi di input "normali" (default) --- */
    input:not([type="checkbox"]):not([type="file"]),
    textarea,
    select {
      border-radius: 0.9rem;
      background: radial-gradient(circle at top, rgba(255, 255, 255, 0.04), rgba(8, 9, 22, 0.96));
      border: 1px solid rgba(88, 105, 140, 0.9);
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.85),
        0 0 18px rgba(0, 0, 0, 0.65);
      font-size: 0.9rem;
      color: var(--arcane-text-main);
      transition:
        box-shadow 160ms ease,
        border-color 160ms ease,
        background 160ms ease;
    }

    input:not([type="checkbox"]):not([type="file"]) {
      padding: 0.45rem 0.7rem;
    }

    textarea {
      padding: 0.5rem 0.75rem;
    }

    select {
      padding: 0.45rem 0.7rem;
      background:
        radial-gradient(circle at top, rgba(255, 255, 255, 0.04), rgba(8, 9, 22, 0.96));
    }

    input::placeholder,
    textarea::placeholder {
      color: rgba(201, 192, 176, 0.6);
    }

    /* focus generico per tutti gli input "normali",
      orb e gem ereditano questo */
    input:not([type="checkbox"]):not([type="file"]):focus-visible,
    textarea:focus-visible,
    select:focus-visible {
      outline: none;
      box-shadow:
        0 0 0 1px rgba(8, 14, 40, 1),
        0 0 0 2px var(--arcane-accent-secondary),
        0 0 20px rgba(125, 220, 255, 0.45);
      border-color: var(--arcane-accent-secondary);
    }

    /* --- Checkbox con runa luminosa --- */
    input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
      border-radius: 0.4rem;
      border: 1px solid rgba(125, 220, 255, 0.55);
      background: radial-gradient(circle at center, rgba(125, 220, 255, 0.2), rgba(4, 8, 26, 1));
      accent-color: var(--arcane-accent-secondary);
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.85),
        0 0 12px rgba(0, 0, 0, 0.7);
    }

    input[type="checkbox"]:checked {
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.9),
        0 0 14px rgba(125, 220, 255, 0.85);
    }

    /* --- Pulsanti: stile generale + varianti primarie --- */
    button {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
      padding: 0.5rem 0.9rem;
      border-radius: 999px;
      font-size: 0.8rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      border: 1px solid rgba(106, 120, 167, 0.9);
      background:
        radial-gradient(circle at top, rgba(255, 255, 255, 0.08), rgba(10, 12, 30, 0.96));
      color: var(--arcane-text-main);
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.9),
        0 10px 25px rgba(0, 0, 0, 0.8);
      transition:
        background 150ms ease,
        border-color 150ms ease,
        transform 120ms ease,
        box-shadow 150ms ease,
        color 150ms ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.9),
        0 16px 30px rgba(0, 0, 0, 0.9);
      background:
        radial-gradient(circle at top, rgba(255, 255, 255, 0.12), rgba(12, 14, 34, 0.98));
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.7),
        0 6px 16px rgba(0, 0, 0, 0.7);
    }

    /* Pulsanti principali (oro) */
    #btnSave,
    #btnSaveBottom,
    #btnImport {
      border-color: var(--arcane-accent);
      background:
        linear-gradient(135deg, rgba(240, 196, 106, 0.15), rgba(240, 196, 106, 0.02)),
        radial-gradient(circle at bottom, rgba(240, 196, 106, 0.95), rgba(96, 62, 14, 0.9));
      color: #160f05;
      text-shadow: 0 0 10px rgba(64, 30, 4, 0.6);
    }

    #btnSave:hover,
    #btnSaveBottom:hover,
    #btnImport:hover {
      background:
        linear-gradient(135deg, rgba(240, 196, 106, 0.24), rgba(240, 196, 106, 0.08)),
        radial-gradient(circle at bottom, rgba(252, 215, 142, 0.98), rgba(102, 60, 4, 0.95));
    }

    /* Tab Discipline un po' più "pillola magica" */
    .discipline-tab {
      border-radius: 999px;
      border-color: rgba(125, 220, 255, 0.55);
      background:
        radial-gradient(circle at top, rgba(125, 220, 255, 0.12), rgba(4, 8, 26, 0.96));
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.85),
        0 8px 18px rgba(0, 0, 0, 0.8);
      font-size: 0.75rem;
      letter-spacing: 0.16em;
    }

    .discipline-tab:hover {
      border-color: rgba(125, 220, 255, 0.9);
      background:
        radial-gradient(circle at top, rgba(125, 220, 255, 0.18), rgba(6, 10, 30, 0.98));
    }

    /* --- Stat principali: input speciali a forma di "orb" --- */
    .stat-orb {
      width: 3.1rem;
      text-align: center;
      border-radius: 999px;
      padding: 0.28rem 0.4rem;
      background:
        radial-gradient(circle at 25% 20%, rgba(255, 255, 255, 0.18), transparent 55%),
        radial-gradient(circle at bottom, rgba(125, 220, 255, 0.3), rgba(6, 8, 24, 1));
      border: 1px solid rgba(234, 200, 140, 0.85);
      box-shadow:
        0 0 0 1px rgba(8, 10, 30, 0.9),
        0 0 18px rgba(171, 227, 255, 0.4);
      font-weight: 600;
      letter-spacing: 0.08em;
      font-size: 0.8rem;
      color: var(--arcane-text-main);
    }

    .stat-orb::placeholder {
      color: rgba(242, 232, 210, 0.6);
    }

    /* Nota nella toolbar superiore */
    .arcane-toolbar-note {
      font-size: 0.7rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(201, 192, 176, 0.8);
    }

    /* Riduzione leggerissima solo per le 12 statistiche principali */
    .main-stat-input {
      width: 3.1rem;       /* = tra w-14 e w-16 → perfetto per mobile */
      /* font-size: 0.85rem;   un hair smaller */
      /* padding-left: 0.25rem;
      padding-right: 0.25rem; */
    }
  </style>
</head>

<body class="min-h-screen">
  <div class="arcane-shell max-w-7xl lg:max-w-[1500px] mx-auto px-3 md:px-6 py-6">
    <!-- Header app -->
    <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-6 relative z-10">
      <div>
        <p class="arcane-subtitle mb-1">Compendio degli Arcanisti</p>
        <h1>Scheda Arcanist</h1>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="btnExport" class="text-xs sm:text-sm disabled:cursor-not-allowed">
          <span>Esporta scheda</span>
        </button>
        <button id="btnImport" class="text-xs sm:text-sm">
          <span>Importa scheda</span>
        </button>
        <input type="file" id="importInput" accept=".json,.txt,application/json,text/plain" class="hidden-input" />
      </div>
    </header>

    <!-- Start screen -->
    <section id="startScreen" class="mt-10 relative z-10">
      <div class="grid gap-6 sm:grid-cols-2">
        <button id="btnStartNew" class="px-5 py-6 text-left">
          <div class="flex flex-col gap-2">
            <p class="text-base">Crea un nuovo personaggio</p>
            <p class="text-sm text-slate-300">
              Inizia da zero.
            </p>
          </div>
        </button>

        <button id="btnStartLoad" class="px-5 py-6 text-left">
          <div class="flex flex-col gap-2">
            <p class="text-base">Carica un personaggio esistente</p>
            <p class="text-sm text-slate-300">
              Carica da file o da browser.
            </p>
          </div>
        </button>
      </div>

      <!-- Picker personaggi start screen -->
      <div id="startCharacterPicker" class="mt-6 hidden">
        <label for="startCharacterList" class="block mb-1">
          Personaggi salvati nel browser
        </label>
        <select id="startCharacterList" class="w-full sm:w-80 text-sm">
          <option value="">– Seleziona personaggio –</option>
        </select>
      </div>

      <p id="noCharactersMsg" class="mt-6 text-sm text-amber-300 hidden">
        Non sono ancora presenti personaggi salvati in questo browser. Puoi importare un file oppure creare una nuova scheda.
      </p>
    </section>

    <!-- Sheet screen -->
    <section id="sheetScreen" class="hidden relative z-10">
      <!-- Top toolbar -->
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-4 mt-8">
        <div class="flex flex-wrap items-center gap-2">
          <button id="btnBackToStart" class="text-[0.7rem] px-3 py-1">
            ← Torna alla scelta iniziale
          </button>
          <span class="arcane-toolbar-note">
            I dati sono salvati solo in questo browser.
          </span>
        </div>

        <div class="flex flex-wrap gap-2 items-center">
          <select id="characterList" class="text-sm min-w-[180px]">
            <option value="">– Seleziona personaggio –</option>
          </select>
          <button id="btnLoadSelected" class="text-xs sm:text-sm">
            Carica selezionato
          </button>
          <button id="btnNew" class="text-xs sm:text-sm">
            Nuova scheda
          </button>
          <button id="btnSave" class="text-xs sm:text-sm">
            Salva scheda
          </button>
        </div>
      </div>

      <!-- Card container -->
      <div class="arcane-page p5 md:p-7 mb-6 mt-4">
        <form id="characterForm" class="space-y-6">
          <!-- Titolo scheda -->
          <section class="border-b border-slate-800/60 pb-4">
            <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
              <div>
                <h2 class="text-base md:text-lg tracking-[0.22em] uppercase text-[var(--arcane-text-muted)]">
                  Scheda del personaggio
                </h2>
              </div>
              <div class="flex flex-wrap gap-3">
                <div class="flex flex-col gap-1 min-w-[180px]">
                  <label for="characterName" class="block mb-1">
                    Nome personaggio *
                  </label>
                  <input id="characterName" name="characterName" required
                         placeholder="Es. Albert De Vis" />
                </div>
              </div>
            </div>
          </section>

          <!-- Trama (4 campi) -->
          <section>
            <h3><span>Trama</span></h3>
            <div class="grid gap-4 md:grid-cols-4">
              <div class="flex flex-col gap-1">
                <label for="tramaCulture" class="mb-1">
                  Cultura
                </label>
                <input id="tramaCulture" name="tramaCulture"
                       placeholder="Dove è nato il tuo PG?" />
              </div>
              <div class="flex flex-col gap-1">
                <label for="tramaRole" class="mb-1">
                  Ruolo
                </label>
                <input id="tramaRole" name="tramaRole"
                       placeholder="Cosa faceva prima di essere un avventuriero?" />
              </div>
              <div class="flex flex-col gap-1">
                <label for="tramaAwakening" class="mb-1">
                  Risveglio
                </label>
                <input id="tramaAwakening" name="tramaAwakening"
                       placeholder="Quando ha risvegliato la magia?" />
              </div>
              <div class="flex flex-col gap-1">
                <label for="tramaTraining" class="mb-1">
                  Formazione
                </label>
                <input id="tramaTraining" name="tramaTraining"
                       placeholder="Come ha sviluppato le sue abilità?" />
              </div>
            </div>
          </section>

          <!-- Trionfi (4 textbox + Segreto) -->
          <section>
            <h3><span>Trionfi</span></h3>
            <div class="grid gap-4 md:grid-cols-4">
              <div class="flex flex-col gap-1">
                <label for="triumphIdentity" class="mb-1">
                  Identità
                </label>
                <input id="triumphIdentity" name="triumphIdentity"
                      placeholder="La tua personalità e alcuni valori di partenza" />
              </div>
              <div class="flex flex-col gap-1">
                <label for="triumphPresent" class="mb-1">
                  Presente
                </label>
                <input id="triumphPresent" name="triumphPresent"
                      placeholder="Attitudini e capacità nelle sfide di ogni giorno" />
              </div>
              <div class="flex flex-col gap-1">
                <label for="triumphPast" class="mb-1">
                  Passato
                </label>
                <input id="triumphPast" name="triumphPast"
                      placeholder="Le prime lezione che la vita ti ha impartito" />
              </div>
              <div class="flex flex-col gap-1">
                <label for="triumphFuture" class="mb-1">
                  Futuro
                </label>
                <input id="triumphFuture" name="triumphFuture"
                      placeholder="Misura della magia, la sua influenza sulla tua vita" />
              </div>
            </div>

            <!-- Riga Segreto con freccina -->
            <div class="mt-3 pt-3 border-t border-slate-800/60">
              <div class="flex items-center justify-between gap-2">
                <span class="text-xs tracking-[0.2em] uppercase text-[var(--arcane-text-muted)]">
                  Segreto
                </span>
                <button type="button" id="secretToggle" class="px-2 py-1 text-[11px]">
                  <span id="secretIcon">▾</span>
                </button>
              </div>

              <div id="secretPanel" class="mt-2 hidden">
                <textarea id="triumphSecret" name="triumphSecret" rows="1"
                          class="w-full resize-y"
                          placeholder="Un difetto cruciale che tormenta l’Arcanista"></textarea>
              </div>
            </div>
          </section>

          <!-- Bloccone 3 colonne -->
          <section>
            <!-- titolo sezione solo mobile -->
            <h3 class="lg:hidden"><span>Attributi &amp; Statistiche</span></h3>

            <!-- NUOVO LAYOUT: grid responsiva -->
            <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-[1fr_4fr_1fr] xl:grid-cols-[1fr_3fr_1fr]">
              <!-- Colonna sinistra: Protezione / Sovraccarico / Fortuna + Vantaggi -->
              <div class="space-y-3 order-2 md:order-2 lg:order-1 lg:col-span-1 lg:col-start-1">
                <div class="rounded-2xl border border-slate-800/70 bg-slate-900/40 p-3">
                  <div class="space-y-2">
                    <div class="flex items-center justify-between gap-2">
                      <label for="statProtection">
                        Protezione
                      </label>
                      <input id="statProtection" name="statProtection" type="text"
                            class="w-16 text-center"
                            placeholder="-" />
                    </div>
                    <div class="flex items-center justify-between gap-2">
                      <label for="statOverload">
                        Sovraccarico
                      </label>
                      <input id="statOverload" name="statOverload" type="text"
                            class="w-16 text-center"
                            placeholder="-" />
                    </div>
                    <div class="flex items-center justify-between gap-2">
                      <label for="statLuck">
                        Fortuna
                      </label>
                      <input id="statLuck" name="statLuck" type="text"
                            class="w-16 text-center"
                            placeholder="-" />
                    </div>
                  </div>

                  <div class="mt-4 border-t border-slate-800/70 pt-3">
                    <div class="flex items-center justify-between gap-2">
                      <label for="advantages">
                        Vantaggi
                      </label>
                      <input id="advantages" name="advantages" type="text"
                            class="w-16 text-center"
                            placeholder="-" />
                    </div>
                  </div>

                </div>
              </div>

              <!-- Colonna centrale: 4 attributi + 12 stat -->
              <div class="space-y-3 order-1 md:order-1 lg:order-2 md:col-span-2 lg:col-span-1 lg:col-start-2">
                <div class="rounded-2xl border border-slate-800/70 bg-slate-900/40 p-3">
                  <!-- titolo attributi/statistiche solo mobile -->
                  <h4 class="text-[11px] font-semibold uppercase tracking-[0.22em] text-[var(--arcane-text-muted)] mb-3 lg:hidden">
                    Attributi principali
                  </h4>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                    <div class="flex flex-col items-center gap-1">
                      <span class="text-[11px] uppercase tracking-wide text-slate-300">Corpo</span>
                      <input id="attrBody" name="attrBody" type="text"
                             class="stat-orb"
                             placeholder="-" />
                    </div>
                    <div class="flex flex-col items-center gap-1">
                      <span class="text-[11px] uppercase tracking-wide text-slate-300">Mente</span>
                      <input id="attrMind" name="attrMind" type="text"
                             class="stat-orb"
                             placeholder="-" />
                    </div>
                    <div class="flex flex-col items-center gap-1">
                      <span class="text-[11px] uppercase tracking-wide text-slate-300">Cuore</span>
                      <input id="attrHeart" name="attrHeart" type="text"
                             class="stat-orb"
                             placeholder="-" />
                    </div>
                    <div class="flex flex-col items-center gap-1">
                      <span class="text-[11px] uppercase tracking-wide text-slate-300">Spirito</span>
                      <input id="attrSpirit" name="attrSpirit" type="text"
                             class="stat-orb"
                             placeholder="-" />
                    </div>
                  </div>

                  <!-- titolo statistiche solo mobile -->
                  <h4 class="text-[11px] font-semibold uppercase tracking-[0.22em] text-[var(--arcane-text-muted)] mb-2 lg:hidden">
                    Statistiche
                  </h4>

                  <!-- 4 blocchi: 3 stat sotto ogni attributo -->
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <!-- Corpo -->
                    <div class="space-y-1">
                      <h5 class="text-[11px] uppercase tracking-wide text-slate-400 text-center md:text-left md:hidden">Corpo</h5>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statPhysique">
                          Fisico
                        </label>
                        <input id="statPhysique" name="statPhysique" type="text"
                               class="main-stat-input sm:!w-16 text-center"
                               placeholder="-/-" />
                      </div>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statDexterity">
                          Destrezza
                        </label>
                        <input id="statDexterity" name="statDexterity" type="text"
                               class="main-stat-input sm:!w-16 text-center"
                               placeholder="-/-" />
                      </div>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statAuthority">
                          Autorità
                        </label>
                        <input id="statAuthority" name="statAuthority" type="text"
                               class="main-stat-input sm:!w-16 text-center"
                               placeholder="-/-" />
                      </div>
                    </div>

                    <!-- Mente -->
                    <div class="space-y-1 border-l border-slate-800 pl-3">
                      <h5 class="text-[11px] uppercase tracking-wide text-slate-400 text-center md:text-left md:hidden">Mente</h5>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statAnalysis">
                          Analisi
                        </label>
                        <input id="statAnalysis" name="statAnalysis" type="text"
                               class="main-stat-input sm:!w-16 text-center"
                               placeholder="-/-" />
                      </div>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statKnowledge">
                          Conoscenza
                        </label>
                        <input id="statKnowledge" name="statKnowledge" type="text"
                               class="main-stat-input sm:!w-16 text-center"
                               placeholder="-/-" />
                      </div>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statRhetoric">
                          Retorica
                        </label>
                        <input id="statRhetoric" name="statRhetoric" type="text"
                               class="main-stat-input sm:!w-16 text-center"
                               placeholder="-/-" />
                      </div>
                    </div>

                    <!-- Cuore -->
                    <div class="space-y-1 md:border-l md:border-slate-800 md:pl-3">
                      <h5 class="text-[11px] uppercase tracking-wide text-slate-400 text-center md:text-left md:hidden">Cuore</h5>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statStealth">
                          Sotterfugio
                        </label>
                        <input id="statStealth" name="statStealth" type="text"
                               class="main-stat-input sm:!w-16 text-center"
                               placeholder="-/-" />
                      </div>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statSurvival">
                          Survival
                        </label>
                        <input id="statSurvival" name="statSurvival" type="text"
                               class="main-stat-input sm:!w-16 text-center"
                               placeholder="-/-" />
                      </div>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statInsight">
                          Intuizione
                        </label>
                        <input id="statInsight" name="statInsight" type="text"
                               class="main-stat-input sm:!w-16 text-center"
                               placeholder="-/-" />
                      </div>
                    </div>

                    <!-- Spirito -->
                    <div class="space-y-1 border-l border-slate-800 pl-3">
                      <h5 class="text-[11px] uppercase tracking-wide text-slate-400 text-center md:text-left md:hidden">Spirito</h5>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statPower">
                          Potenza
                        </label>
                        <input id="statPower" name="statPower" type="text"
                               class="main-stat-input sm:!w-16 text-center"
                               placeholder="-/-" />
                      </div>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statControl">
                          Controllo
                        </label>
                        <input id="statControl" name="statControl" type="text"
                               class="main-stat-input sm:!w-16 text-center"
                               placeholder="-/-" />
                      </div>
                      <div class="flex items-center justify-between gap-2">
                        <label for="statPerception">
                          Percezione
                        </label>
                        <input id="statPerception" name="statPerception" type="text"
                               class="main-stat-input sm:!w-16 text-center"
                               placeholder="-/-" />
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Colonna destra: Vitalità / Resistenza / Caos + Esperienza -->
              <div class="space-y-3 order-3 md:order-3 lg:order-3 lg:col-span-1 lg:col-start-3">
                <div class="rounded-2xl border border-slate-800/70 bg-slate-900/40 p-3">
                  <div class="space-y-2">
                    <div class="flex items-center justify-between gap-2">
                      <label for="statVitality">
                        Vitalità
                      </label>
                      <input id="statVitality" name="statVitality" type="text"
                             class="w-16 text-center"
                             placeholder="-/-" />
                    </div>
                    <div class="flex items-center justify-between gap-2">
                      <label for="statStamina">
                        Resistenza
                      </label>
                      <input id="statStamina" name="statStamina" type="text"
                             class="w-16 text-center"
                             placeholder="-" />
                    </div>
                    <div class="flex items-center justify-between gap-2">
                      <label for="statChaos">
                        Caos
                      </label>
                      <input id="statChaos" name="statChaos" type="text"
                             class="w-16 text-center"
                             placeholder="-/-" />
                    </div>
                  </div>

                  <!-- Esperienza -->
                  <div class="mt-4 border-t border-slate-800/70 pt-3">
                    <div class="flex items-center justify-between gap-2">
                      <label for="experience">
                        Esperienza
                      </label>
                      <input id="experience" name="experience" type="text"
                             class="w-16 text-center"
                             placeholder="-" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Condizioni -->
          <section>
            <h3><span>Condizioni</span></h3>

            <textarea id="conditions" name="conditions" rows="1"
                      class="w-full resize-y"
                      placeholder="Accecato, affaticato, etc..."></textarea>
          </section>

          <!-- Discipline -->
          <section>
            <h3><span>Discipline</span></h3>

            <div class="rounded-2xl border border-slate-800/70 bg-slate-900/40 p-4 space-y-4">
              <!-- Nomi discipline orizzontali -->
              <div class="flex flex-wrap gap-2">
                <button type="button"
                        class="discipline-tab text-[0.7rem] sm:text-xs px-3 py-1.5"
                        data-discipline-target="disc-acqua-panel">
                  Acqua
                </button>
                <button type="button"
                        class="discipline-tab text-[0.7rem] sm:text-xs px-3 py-1.5"
                        data-discipline-target="disc-aria-panel">
                  Aria
                </button>
                <button type="button"
                        class="discipline-tab text-[0.7rem] sm:text-xs px-3 py-1.5"
                        data-discipline-target="disc-fuoco-panel">
                  Fuoco
                </button>
                <button type="button"
                        class="discipline-tab text-[0.7rem] sm:text-xs px-3 py-1.5"
                        data-discipline-target="disc-terra-panel">
                  Terra
                </button>
                <button type="button"
                        class="discipline-tab text-[0.7rem] sm:text-xs px-3 py-1.5"
                        data-discipline-target="disc-luce-panel">
                  Luce
                </button>
                <button type="button"
                        class="discipline-tab text-[0.7rem] sm:text-xs px-3 py-1.5"
                        data-discipline-target="disc-vita-panel">
                  Vita
                </button>
                <button type="button"
                        class="discipline-tab text-[0.7rem] sm:text-xs px-3 py-1.5"
                        data-discipline-target="disc-natura-panel">
                  Natura
                </button>
                <button type="button"
                        class="discipline-tab text-[0.7rem] sm:text-xs px-3 py-1.5"
                        data-discipline-target="disc-spirito-panel">
                  Spirito
                </button>
                <button type="button"
                        class="discipline-tab text-[0.7rem] sm:text-xs px-3 py-1.5"
                        data-discipline-target="disc-oscurita-panel">
                  Oscurità
                </button>
                <button type="button"
                        class="discipline-tab text-[0.7rem] sm:text-xs px-3 py-1.5"
                        data-discipline-target="disc-spazio-panel">
                  Spazio
                </button>
                <button type="button"
                        class="discipline-tab text-[0.7rem] sm:text-xs px-3 py-1.5"
                        data-discipline-target="disc-tempo-panel">
                  Tempo
                </button>
              </div>

              <!-- Pannelli accordion -->
              <div class="space-y-3">
                <!-- Acqua (2 lezioni) -->
                <div id="disc-acqua-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    ACQUA
                  </h4>
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discAcquaLesson1" type="checkbox">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discAcquaLesson2" type="checkbox">
                        <span>Lezione 2</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discAcquaGrade" type="text"
                            class="w-16 text-center"
                            placeholder="-/3"/>
                    </div>
                  </div>
                </div>

                <!-- Aria (2 lezioni) -->
                <div id="disc-aria-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    ARIA
                  </h4>
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discAriaLesson1" type="checkbox">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discAriaLesson2" type="checkbox">
                        <span>Lezione 2</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discAriaGrade" type="text"
                            class="w-16 text-center"
                            placeholder="-/3"/>
                    </div>
                  </div>
                </div>

                <!-- Fuoco (2 lezioni) -->
                <div id="disc-fuoco-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    FUOCO
                  </h4>
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discFuocoLesson1" type="checkbox">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discFuocoLesson2" type="checkbox">
                        <span>Lezione 2</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discFuocoGrade" type="text"
                            class="w-16 text-center"
                            placeholder="-/3"/>
                    </div>
                  </div>
                </div>

                <!-- Terra (2 lezioni) -->
                <div id="disc-terra-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    TERRA
                  </h4>
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discTerraLesson1" type="checkbox">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discTerraLesson2" type="checkbox">
                        <span>Lezione 2</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discTerraGrade" type="text"
                            class="w-16 text-center"
                            placeholder="-/3"/>
                    </div>
                  </div>
                </div>

                <!-- Luce (2 lezioni) -->
                <div id="disc-luce-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    LUCE
                  </h4>
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discLuceLesson1" type="checkbox">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discLuceLesson2" type="checkbox">
                        <span>Lezione 2</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discLuceGrade" type="text"
                            class="w-16 text-center"
                            placeholder="-/3"/>
                    </div>
                  </div>
                </div>

                <!-- Vita (3 lezioni) -->
                <div id="disc-vita-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    VITA
                  </h4>
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discVitaLesson1" type="checkbox">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discVitaLesson2" type="checkbox">
                        <span>Lezione 2</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discVitaLesson3" type="checkbox">
                        <span>Lezione 3</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discVitaGrade" type="text"
                            class="w-16 text-center"
                            placeholder="-/3"/>
                    </div>
                  </div>
                </div>

                <!-- Natura (3 lezioni) -->
                <div id="disc-natura-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    NATURA
                  </h4>
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discNaturaLesson1" type="checkbox">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discNaturaLesson2" type="checkbox">
                        <span>Lezione 2</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discNaturaLesson3" type="checkbox">
                        <span>Lezione 3</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discNaturaGrade" type="text"
                            class="w-16 text-center"
                            placeholder="-/3"/>
                    </div>
                  </div>
                </div>

                <!-- Spirito (3 lezioni) -->
                <div id="disc-spirito-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    SPIRITO
                  </h4>
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discSpiritoLesson1" type="checkbox">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discSpiritoLesson2" type="checkbox">
                        <span>Lezione 2</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discSpiritoLesson3" type="checkbox">
                        <span>Lezione 3</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discSpiritoGrade" type="text"
                            class="w-16 text-center"
                            placeholder="-/3"/>
                    </div>
                  </div>
                </div>

                <!-- Oscurità (3 lezioni) -->
                <div id="disc-oscurita-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    OSCURITÀ
                  </h4>
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discOscuritaLesson1" type="checkbox">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discOscuritaLesson2" type="checkbox">
                        <span>Lezione 2</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discOscuritaLesson3" type="checkbox">
                        <span>Lezione 3</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discOscuritaGrade" type="text"
                            class="w-16 text-center"
                            placeholder="-/3"/>
                    </div>
                  </div>
                </div>

                <!-- Spazio (4 lezioni) -->
                <div id="disc-spazio-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    SPAZIO
                  </h4>
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discSpazioLesson1" type="checkbox">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discSpazioLesson2" type="checkbox">
                        <span>Lezione 2</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discSpazioLesson3" type="checkbox">
                        <span>Lezione 3</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discSpazioLesson4" type="checkbox">
                        <span>Lezione 4</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discSpazioGrade" type="text"
                            class="w-16 text-center"
                            placeholder="-/3"/>
                    </div>
                  </div>
                </div>

                <!-- Tempo (4 lezioni) -->
                <div id="disc-tempo-panel" data-discipline-panel class="hidden rounded-xl border border-slate-700 bg-slate-950/70 p-3">
                  <h4 class="text-[11px] uppercase tracking-wide text-slate-300 mb-2 text-center">
                    TEMPO
                  </h4>
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex flex-wrap gap-2">
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discTempoLesson1" type="checkbox">
                        <span>Lezione 1</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discTempoLesson2" type="checkbox">
                        <span>Lezione 2</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discTempoLesson3" type="checkbox">
                        <span>Lezione 3</span>
                      </label>
                      <label class="inline-flex items-center gap-1 text-xs text-slate-300">
                        <input id="discTempoLesson4" type="checkbox">
                        <span>Lezione 4</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs uppercase tracking-wide text-slate-300">Grado</span>
                      <input id="discTempoGrade" type="text"
                            class="w-16 text-center"
                            placeholder="-/3"/>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Equipaggiamento -->
          <section>
            <h3><span>Equipaggiamento</span></h3>
            <div class="grid gap-4 md:grid-cols-2">
              <div class="flex flex-col gap-1">
                <label for="equipWeaponsSpells" class="mb-1">
                  Armi e Incantesimi
                </label>
                <textarea id="equipWeaponsSpells" name="equipWeaponsSpells" rows="4"
                          class="resize-y"
                          placeholder="- Arma / incantesimo&#10;- Danno / effetto&#10;- Note..."></textarea>
              </div>
              <div class="flex flex-col gap-1">
                <label for="equipAccessories" class="mb-1">
                  Accessori
                </label>
                <textarea id="equipAccessories" name="equipAccessories" rows="4"
                          class="resize-y"
                          placeholder="- Anelli, amuleti, talismani&#10;- Effetti passivi..."></textarea>
              </div>
              <div class="flex flex-col gap-1">
                <label for="equipTools" class="mb-1">
                  Strumenti
                </label>
                <textarea id="equipTools" name="equipTools" rows="4"
                          class="resize-y"
                          placeholder="- Kit, attrezzi, focus rituali..."></textarea>
              </div>
              <div class="flex flex-col gap-1">
                <label for="equipOther" class="mb-1">
                  Altro Equipaggiamento
                </label>
                <textarea id="equipOther" name="equipOther" rows="4"
                          class="resize-y"
                          placeholder="- Oggetti vari, risorse..."></textarea>
              </div>
              <div class="flex flex-col gap-1 md:col-span-2">
                <label for="equipLoot" class="mb-1">
                  Bottino
                </label>
                <textarea id="equipLoot" name="equipLoot" rows="1"
                          class="resize-y"
                          placeholder="Valute e beni di scambio"></textarea>
              </div>
            </div>
          </section>

          <!-- Influenze -->
          <section>
            <h3><span>Influenze</span></h3>
            <textarea id="influences" name="influences" rows="3"
                      class="w-full resize-y"></textarea>

            <div class="mt-3 flex flex-col gap-1 w-full">
              <label for="reputation" class="mb-1">
                Reputazione
              </label>
              <input id="reputation" name="reputation" class="w-full" />
            </div>
          </section>

          <!-- Arti e Poteri -->
          <section>
            <h3><span>Arti e Poteri</span></h3>
            <textarea id="artsPowers" name="artsPowers" rows="5"
                      class="w-full resize-y"></textarea>
          </section>

          <!-- Note -->
          <section>
            <h3><span>Note</span></h3>
            <textarea id="notes" name="notes" rows="5"
                      class="w-full resize-y"
                      placeholder="Appunti di sessione, idee future..."></textarea>
          </section>
        </form>
      </div>

      <!-- Bottom action bar -->
      <div class="flex flex-wrap gap-2 justify-end">
        <button id="btnNewBottom" class="text-xs sm:text-sm">
          Crea nuova scheda
        </button>
        <button id="btnSaveBottom" class="text-xs sm:text-sm">
          Salva scheda
        </button>
      </div>
    </section>
  </div>

  <script>
    // -----------------------------
    // Storage helpers (no CRUD in loops)
    // -----------------------------
    const STORAGE_KEY = "arcanist_characters_v1";

    function loadAllCharacters() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        return {};
      }
      try {
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === "object" ? parsed : {};
      } catch (e) {
        console.error("Error parsing characters from storage", e);
        return {};
      }
    }

    function saveAllCharacters(characters) {
      const serialized = JSON.stringify(characters);
      localStorage.setItem(STORAGE_KEY, serialized);
    }

    // -----------------------------
    // UI state
    // -----------------------------
    const startScreen = document.getElementById("startScreen");
    const sheetScreen = document.getElementById("sheetScreen");
    const characterForm = document.getElementById("characterForm");
    const characterList = document.getElementById("characterList");
    const noCharactersMsg = document.getElementById("noCharactersMsg");
    const startCharacterPicker = document.getElementById("startCharacterPicker");
    const startCharacterList = document.getElementById("startCharacterList");

    const btnStartNew = document.getElementById("btnStartNew");
    const btnStartLoad = document.getElementById("btnStartLoad");
    const btnBackToStart = document.getElementById("btnBackToStart");

    const btnNew = document.getElementById("btnNew");
    const btnSave = document.getElementById("btnSave");
    const btnLoadSelected = document.getElementById("btnLoadSelected");
    const btnExport = document.getElementById("btnExport");
    const btnImport = document.getElementById("btnImport");
    const importInput = document.getElementById("importInput");

    const btnNewBottom = document.getElementById("btnNewBottom");
    const btnSaveBottom = document.getElementById("btnSaveBottom");

    const characterNameInput = document.getElementById("characterName");

    let currentCharacterId = null;

    // -----------------------------
    // Screen navigation
    // -----------------------------
    function showStartScreen() {
      startScreen.classList.remove("hidden");
      sheetScreen.classList.add("hidden");
      refreshStartScreenMessage();
    }

    function showSheetScreen() {
      startScreen.classList.add("hidden");
      sheetScreen.classList.remove("hidden");
      refreshCharacterList();
    }

    function refreshStartScreenMessage() {
      const characters = loadAllCharacters();
      const hasCharacters = Object.keys(characters).length > 0;
      noCharactersMsg.classList.toggle("hidden", hasCharacters);
    }

    // -----------------------------
    // Form <-> data mapping
    // -----------------------------
    const FIELD_IDS = [
      "characterName",
      // --- Trama ---
      "tramaCulture",
      "tramaRole",
      "tramaAwakening",
      "tramaTraining",
      // --- Trionfi ---
      "triumphIdentity",
      "triumphPresent",
      "triumphPast",
      "triumphFuture",
      "triumphSecret",
      // --- Main Attributes ---
      "attrBody",
      "attrMind",
      "attrHeart",
      "attrSpirit",
      // --- Main Statistics (12) ---
      "statPhysique",
      "statDexterity",
      "statAuthority",
      "statAnalysis",
      "statKnowledge",
      "statRhetoric",
      "statStealth",
      "statSurvival",
      "statInsight",
      "statPower",
      "statControl",
      "statPerception",
      // --- Secondary Statistics (6) ---
      "statProtection",
      "statOverload",
      "statLuck",
      "statVitality",
      "statStamina",
      "statChaos",
      // --- Advantages / XP / Conditions ---
      "advantages",
      "experience",
      "conditions",
      // --- Discipline: Acqua ---
      "discAcquaLesson1",
      "discAcquaLesson2",
      "discAcquaGrade",
      // --- Discipline: Aria ---
      "discAriaLesson1",
      "discAriaLesson2",
      "discAriaGrade",
      // --- Discipline: Fuoco ---
      "discFuocoLesson1",
      "discFuocoLesson2",
      "discFuocoGrade",
      // --- Discipline: Terra ---
      "discTerraLesson1",
      "discTerraLesson2",
      "discTerraGrade",
      // --- Discipline: Luce ---
      "discLuceLesson1",
      "discLuceLesson2",
      "discLuceGrade",
      // --- Discipline: Vita ---
      "discVitaLesson1",
      "discVitaLesson2",
      "discVitaLesson3",
      "discVitaGrade",
      // --- Discipline: Natura ---
      "discNaturaLesson1",
      "discNaturaLesson2",
      "discNaturaLesson3",
      "discNaturaGrade",
      // --- Discipline: Spirito ---
      "discSpiritoLesson1",
      "discSpiritoLesson2",
      "discSpiritoLesson3",
      "discSpiritoGrade",
      // --- Discipline: Oscurità ---
      "discOscuritaLesson1",
      "discOscuritaLesson2",
      "discOscuritaLesson3",
      "discOscuritaGrade",
      // --- Discipline: Spazio ---
      "discSpazioLesson1",
      "discSpazioLesson2",
      "discSpazioLesson3",
      "discSpazioLesson4",
      "discSpazioGrade",
      // --- Discipline: Tempo ---
      "discTempoLesson1",
      "discTempoLesson2",
      "discTempoLesson3",
      "discTempoLesson4",
      "discTempoGrade",
      // --- Equipment ---
      "equipWeaponsSpells",
      "equipAccessories",
      "equipTools",
      "equipOther",
      "equipLoot",
      // --- Influences & Reputation ---
      "influences",
      "reputation",
      // --- Arts & Powers ---
      "artsPowers",
      // --- Notes ---
      "notes"
    ];

    function forEachField(callback) {
      FIELD_IDS.forEach((id) => {
        const el = document.getElementById(id);
        if (el) callback(el, id);
      });
    }

    function getFormData() {
      const data = {};
      forEachField((el, id) => {
        if (el.type === "checkbox") {
          data[id] = el.checked;
        } else {
          data[id] = el.value;
        }
      });
      return data;
    }

    function setFormData(data = {}) {
      forEachField((el, id) => {
        if (el.type === "checkbox") {
          el.checked = Boolean(data[id]);
        } else {
          el.value = data[id] ?? "";
        }
      });
    }

    function clearForm() {
      setFormData({});
      currentCharacterId = null;
      updateExportButtonState();
    }

    // -----------------------------
    // Segreto accordion (Trionfi)
    // -----------------------------
    const secretToggle = document.getElementById("secretToggle");
    const secretPanel = document.getElementById("secretPanel");
    const secretIcon = document.getElementById("secretIcon");

    if (secretToggle && secretPanel && secretIcon) {
      secretToggle.addEventListener("click", () => {
        const isHidden = secretPanel.classList.contains("hidden");
        secretPanel.classList.toggle("hidden");
        secretIcon.textContent = isHidden ? "▴" : "▾";
      });
    }

    // -----------------------------
    // Discipline accordion
    // -----------------------------
    const disciplineTabs = document.querySelectorAll(".discipline-tab");
    const disciplinePanels = document.querySelectorAll("[data-discipline-panel]");

    disciplineTabs.forEach((btn) => {
      btn.addEventListener("click", () => {
        const targetId = btn.getAttribute("data-discipline-target");
        const panel = document.getElementById(targetId);
        if (!panel) {
          return;
        }

        const isHidden = panel.classList.contains("hidden");
        if (isHidden) {
          panel.classList.remove("hidden");
          btn.classList.add("bg-slate-800");
        } else {
          panel.classList.add("hidden");
          btn.classList.remove("bg-slate-800");
        }
      });
    });

    // -----------------------------
    // Character list management
    // -----------------------------
    function createCharacterIdFromName(name) {
      const normalized = (name || "").trim().toLowerCase();
      if (!normalized) {
        return null;
      }
      return normalized
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "")
        .slice(0, 60) || null;
    }

    function fillCharacterSelect(selectEl, characters, ids) {
      if (!selectEl) return;
      selectEl.innerHTML = '<option value="">– Seleziona personaggio –</option>';
      ids.forEach((id) => {
        const option = document.createElement("option");
        const name = characters[id]?.characterName || id;
        option.value = id;
        option.textContent = name;
        selectEl.appendChild(option);
      });
    }

    function refreshCharacterList() {
      const characters = loadAllCharacters();
      const ids = Object.keys(characters).sort();

      fillCharacterSelect(characterList, characters, ids);
      fillCharacterSelect(startCharacterList, characters, ids);
    }

    function loadCharacterById(id) {
      if (!id) {
        return;
      }
      const characters = loadAllCharacters();
      const data = characters[id];
      if (!data) {
        alert("Personaggio non trovato, potrebbe essere stato rimosso.");
        refreshCharacterList();
        return;
      }
      currentCharacterId = id;
      setFormData(data);
      updateExportButtonState();
    }

    // -----------------------------
    // Save / New / Load
    // -----------------------------
    function handleNewCharacter() {
      clearForm();
      if (characterNameInput) {
        characterNameInput.focus();
      }
    }

    function handleSaveCharacter() {
      const data = getFormData();
      const name = (data.characterName || "").trim();

      if (!name) {
        alert("Inserisci almeno il nome del personaggio per poter salvare.");
        characterNameInput.focus();
        return;
      }

      let id = currentCharacterId || createCharacterIdFromName(name);
      if (!id) {
        alert("Nome non valido. Riprova con un nome diverso.");
        return;
      }

      const characters = loadAllCharacters();
      const isNew = !characters[id];

      if (!isNew && !currentCharacterId && !confirm("Esiste già un personaggio con questo nome. Sovrascrivere?")) {
        return;
      }

      characters[id] = data;
      saveAllCharacters(characters);
      currentCharacterId = id;
      refreshCharacterList();
      updateExportButtonState();
      alert("Scheda salvata nel browser.");
    }

    function handleLoadSelected() {
      const id = characterList.value;
      if (!id) {
        alert("Seleziona un personaggio dalla lista.");
        return;
      }
      loadCharacterById(id);
    }

    // -----------------------------
    // Export / Import
    // -----------------------------
    function updateExportButtonState() {
      const data = getFormData();
      const canExport = !!(data.characterName && data.characterName.trim());
      btnExport.disabled = !canExport;
    }

    function handleExport() {
      const data = getFormData();
      const nameSafe = (data.characterName || "personaggio")
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "") || "personaggio";
    
      // JSON come contenuto, ma salvato in .txt
      const payload = JSON.stringify(data, null, 2);
      const blob = new Blob([payload], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
    
      const a = document.createElement("a");
      a.href = url;
      a.download = `scheda-${nameSafe}.txt`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function handleImportClick() {
      importInput.value = "";
      importInput.click();
    }

    function handleImportFileChange(event) {
      const file = event.target.files && event.target.files[0];
      if (!file) {
        return;
      }
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const text = String(e.target?.result || "");
          const parsed = JSON.parse(text);
          if (!parsed || typeof parsed !== "object") {
            alert("File non valido: il contenuto non è un JSON di scheda.");
            return;
          }
          setFormData(parsed);
          updateExportButtonState();

          const name = (parsed.characterName || "").trim();
          if (name) {
            const id = createCharacterIdFromName(name);
            if (id) {
              const characters = loadAllCharacters();
              characters[id] = parsed;
              saveAllCharacters(characters);
              currentCharacterId = id;
              refreshCharacterList();
            }
          }

          showSheetScreen();
          alert("Scheda importata correttamente.");
        } catch (err) {
          console.error(err);
          alert("Errore durante l'import: assicurati che il file sia stato esportato dall'app o sia un JSON valido.");
        }
      };
      reader.readAsText(file);
    }

    // -----------------------------
    // Events wiring
    // -----------------------------
    btnStartNew.addEventListener("click", () => {
      showSheetScreen();
      handleNewCharacter();
    });

    btnStartLoad.addEventListener("click", () => {
      const characters = loadAllCharacters();
      const hasCharacters = Object.keys(characters).length > 0;

      if (!hasCharacters) {
        refreshStartScreenMessage();
        alert("Nessun personaggio salvato in questo browser. Puoi importare una scheda da file.");
        handleImportClick();
      } else {
        // mostra il dropdown nella start screen
        refreshCharacterList();
        if (startCharacterPicker) {
          startCharacterPicker.classList.remove("hidden");
        }
      }
    });

    if (startCharacterList) {
      startCharacterList.addEventListener("change", () => {
        const id = startCharacterList.value;
        if (!id) {
          return;
        }
        loadCharacterById(id);  // carica i dati nel form
        showSheetScreen();      // passa alla schermata della scheda
      });
    }

    btnBackToStart.addEventListener("click", () => {
      showStartScreen();
    });

    btnNew.addEventListener("click", handleNewCharacter);
    btnNewBottom.addEventListener("click", handleNewCharacter);

    btnSave.addEventListener("click", handleSaveCharacter);
    btnSaveBottom.addEventListener("click", handleSaveCharacter);

    btnLoadSelected.addEventListener("click", handleLoadSelected);

    btnExport.addEventListener("click", handleExport);
    btnImport.addEventListener("click", handleImportClick);
    importInput.addEventListener("change", handleImportFileChange);

    characterForm.addEventListener("input", () => {
      updateExportButtonState();
    });

    // -----------------------------
    // Initial setup
    // -----------------------------
    refreshStartScreenMessage();
    updateExportButtonState();
  </script>
</body>
</html>
